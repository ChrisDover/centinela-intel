generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Subscriber {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String?
  status           String    @default("active") // active, unsubscribed, bounced
  subscribedAt     DateTime  @default(now())
  unsubscribedAt   DateTime?
  unsubscribeToken String    @unique @default(cuid())

  // Engagement tracking
  emailsSent       Int       @default(0)
  emailsOpened     Int       @default(0)
  emailsClicked    Int       @default(0)
  engagementScore  Int       @default(0)

  // Source tracking
  source           String? // homepage, subscribe-page, brief, contact

  // Send-time optimization
  timezone            String?   // IANA timezone e.g. "America/Mexico_City"
  optimalSendHour     Int?      // 0-23, calculated from open history
  sendTimeConfidence  Float     @default(0) // 0-1
  lastOpenAnalyzedAt  DateTime?

  emailEvents       EmailEvent[]
  emailSends        EmailSend[]
  abTestAssignments ABTestAssignment[]
  ctaClicks         CTAClick[]

  @@map("subscribers")
}

model EmailCampaign {
  id              String    @id @default(cuid())
  type            String    // brief, broadcast, welcome, alert
  subject         String
  fromEmail       String    @default("Centinela Intel <intel@centinelaintel.com>")
  sentAt          DateTime  @default(now())

  recipientCount  Int       @default(0)
  deliveredCount  Int       @default(0)
  openedCount     Int       @default(0)
  clickedCount    Int       @default(0)
  bouncedCount    Int       @default(0)
  complainedCount Int       @default(0)

  openRate        Float?
  clickRate       Float?

  tags            String?
  notes           String?

  // New fields for intelligent platform
  htmlContent     String?   // full email HTML
  textContent     String?   // plain text fallback
  abTestId        String?   // linked A/B test
  status          String    @default("draft") // draft, sending, sent, scheduled
  scheduledFor    DateTime?

  emailEvents     EmailEvent[]
  emailSends      EmailSend[]
  ctaClicks       CTAClick[]

  @@map("email_campaigns")
}

model EmailEvent {
  id           String         @id @default(cuid())
  subscriberId String?
  campaignId   String?
  emailId      String? // Resend email ID
  type         String // delivered, opened, clicked, bounced, complained
  timestamp    DateTime       @default(now())
  metadata     String? // JSON string

  subscriber   Subscriber?    @relation(fields: [subscriberId], references: [id])
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])

  @@index([subscriberId])
  @@index([campaignId])
  @@index([emailId])
  @@map("email_events")
}

model ABTest {
  id            String    @id @default(cuid())
  name          String
  type          String    // subject, headline, layout, cta
  status        String    @default("running") // running, completed, cancelled
  variants      String    // JSON array of {id, value}
  winnerVariant String?
  metric        String    @default("open_rate") // open_rate, click_rate
  minSampleSize Int       @default(30)
  campaignId    String?
  createdAt     DateTime  @default(now())
  completedAt   DateTime?

  assignments   ABTestAssignment[]

  @@map("ab_tests")
}

model ABTestAssignment {
  id           String  @id @default(cuid())
  testId       String
  subscriberId String
  variantId    String
  opened       Boolean @default(false)
  clicked      Boolean @default(false)

  test         ABTest     @relation(fields: [testId], references: [id])
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id])

  @@unique([testId, subscriberId])
  @@index([testId])
  @@index([subscriberId])
  @@map("ab_test_assignments")
}

model EmailSend {
  id             String    @id @default(cuid())
  campaignId     String
  subscriberId   String
  resendEmailId  String?
  variantId      String?
  scheduledAt    DateTime?
  sentAt         DateTime?
  status         String    @default("pending") // pending, scheduled, sent, failed

  campaign       EmailCampaign @relation(fields: [campaignId], references: [id])
  subscriber     Subscriber    @relation(fields: [subscriberId], references: [id])

  @@index([campaignId])
  @@index([subscriberId])
  @@index([resendEmailId])
  @@map("email_sends")
}

model CTAClick {
  id           String    @id @default(cuid())
  subscriberId String?
  campaignId   String?
  ctaType      String    // trendlock, thunderdome, premium, briefing
  ctaPosition  String?   // header, body, footer
  url          String
  clickedAt    DateTime  @default(now())

  subscriber   Subscriber?    @relation(fields: [subscriberId], references: [id])
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])

  @@index([subscriberId])
  @@index([campaignId])
  @@index([ctaType])
  @@map("cta_clicks")
}

model Client {
  id                   String    @id @default(cuid())
  email                String    @unique
  name                 String?
  company              String?

  // Stripe
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  plan                 String    @default("country-monitor")
  planTier             String    @default("1-country") // 1-country, 2-country, 3-country, all-countries
  planStatus           String    @default("active") // active, past_due, cancelled

  // Country Monitor config
  country              String? // primary country code (legacy, use countries)
  countryName          String? // primary country name (legacy, use countries)
  countries            String? // JSON array of {code, name} e.g. [{"code":"MX","name":"Mexico"}]
  focusAreas           String? // JSON array of focus areas e.g. ["Guadalajara","Sinaloa"]

  // Auth
  magicLinkToken       String?
  magicLinkExpiresAt   DateTime?
  sessionToken         String?   @unique
  sessionExpiresAt     DateTime?

  createdAt            DateTime  @default(now())
  onboardedAt          DateTime?

  @@map("clients")
}

model CheckoutAttempt {
  id              String   @id @default(cuid())
  tier            String   // 1-country, 2-country, 3-country, all-countries
  status          String   @default("initiated") // initiated, completed, failed, cancelled
  email           String?  // populated on completion via webhook
  stripeSessionId String?  @unique
  stripeCustomerId String?
  ip              String?
  userAgent       String?
  errorMessage    String?
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("checkout_attempts")
}

model ClientBrief {
  id          String   @id @default(cuid())
  country     String // country code
  countryName String
  date        String // "February 11, 2026"
  threatLevel String // MODERATE, ELEVATED, HIGH, CRITICAL
  content     String // JSON string of full brief data
  createdAt   DateTime @default(now())

  @@unique([country, date])
  @@index([country])
  @@map("client_briefs")
}
